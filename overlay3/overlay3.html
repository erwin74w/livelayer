<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lower Third Overlay (Supabase)</title>
    <link rel="stylesheet" href="overlay3.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="lowerThirdContainer" class="lower-third-container">
        <div id="ltName" class="lt-name"></div>
        <div id="ltFunction" class="lt-function"></div>
        <div id="ltAffiliation" class="lt-affiliation"></div>
    </div>
    <script>
        const urlParamsOverlay = new URLSearchParams(window.location.search);
        const userIdForThisOverlay = urlParamsOverlay.get('user');
        const OVERLAY_TYPE = 'lower_third';
        const LOG_PREFIX = `Overlay3 (${OVERLAY_TYPE}) for User [${userIdForThisOverlay || 'NO_USER_ID_PARAM'}]:`;
        console.log(LOG_PREFIX, "Script started.");

        if (!userIdForThisOverlay) { /* ... (error handling for missing user ID) ... */ }

        const nameEl = getEl('ltName'); // Use getEl if you define it, or document.getElementById
        const functionEl = getEl('ltFunction');
        const affiliationEl = getEl('ltAffiliation');
        const containerEl = getEl('lowerThirdContainer');
        const defaultLowerThirdData = { name: "N/A", function: "", affiliation: "" };
        let supabaseClient = null;

        function getEl(id){ return document.getElementById(id); } // Local getEl for this file

        async function initializeSupabaseForOverlay() { /* ... (Same as overlay1.html) ... */ }

        function updateLowerThirdContent(dataToDisplay, source = "Unknown") {
            console.log(LOG_PREFIX, `updateLowerThirdContent called from [${source}]`);
            // ... (rest of updateLowerThirdContent logic from last full working version)
        }

        async function fetchAndApplyConfig(triggeredBy = "InitialLoad") {
            console.log(LOG_PREFIX, `fetchAndApplyConfig called, triggered by: [${triggeredBy}]`);
            if (!supabaseClient || !userIdForThisOverlay) { /* ... */ return; }
            console.log(LOG_PREFIX, "Fetching config for user_id:", userIdForThisOverlay);
            try {
                const { data, error } = await supabaseClient
                    .from('overlay_configurations')
                    .select('config_data')
                    .eq('overlay_type', OVERLAY_TYPE)
                    .eq('user_id', userIdForThisOverlay)
                    .maybeSingle();
                if (error) { /* ... */ updateLowerThirdContent(null, `FetchConfig-Error-${triggeredBy}`);}
                else if (data && data.config_data) { updateLowerThirdContent(data.config_data, `FetchConfig-Success-${triggeredBy}`); }
                else { updateLowerThirdContent(null, `FetchConfig-NoData-${triggeredBy}`); }
            } catch (fetchError) { /* ... */ updateLowerThirdContent(null, `FetchConfig-Exception-${triggeredBy}`); }
        }

        const updateCommandKey = `${OVERLAY_TYPE}-executeUpdateCmd`;
        window.addEventListener('storage', (event) => {
            if (event.key === updateCommandKey && event.newValue !== null) {
                console.log(LOG_PREFIX, `Received '${updateCommandKey}' from localStorage. Re-fetching config.`);
                fetchAndApplyConfig("LocalStorageUpdate");
            }
        });

        async function main() {
            if (!userIdForThisOverlay) { updateLowerThirdContent(null, "Main-NoUserID"); return; }
            const supabaseReady = await initializeSupabaseForOverlay();
            if (supabaseReady) { await fetchAndApplyConfig("InitialLoad"); }
            else { updateLowerThirdContent(null, "Main-SupabaseInitFail"); }
        }

        if (userIdForThisOverlay) { main(); } else { updateLowerThirdContent(null); }
    </script>
</body>
</html>
