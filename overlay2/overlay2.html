<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticker Overlay (Supabase)</title>
    <link rel="stylesheet" href="overlay2.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="ticker-container">
        <div id="ticker-text">Loading ticker...</div>
    </div>
    <script>
        const urlParamsOverlay = new URLSearchParams(window.location.search);
        const userIdForThisOverlay = urlParamsOverlay.get('user');
        const OVERLAY_TYPE = 'ticker';
        const LOG_PREFIX = `Overlay2 (${OVERLAY_TYPE}) for User [${userIdForThisOverlay || 'NO_USER_ID_PARAM'}]:`;
        console.log(LOG_PREFIX, "Script started.");

        if (!userIdForThisOverlay) { /* ... (error handling for missing user ID) ... */ }

        const tickerTextElement = document.getElementById('ticker-text');
        const defaultTickerData = { messages: ["Ticker not yet configured..."], separator: " â€¢ " };
        let supabaseClient = null;

        async function initializeSupabaseForOverlay() { /* ... (Same as overlay1.html) ... */ }

        function displayTicker(dataToDisplay, source = "Unknown") {
            console.log(LOG_PREFIX, `displayTicker called from [${source}]`);
            // ... (rest of displayTicker logic from last full working version)
        }

        async function fetchAndApplyConfig(triggeredBy = "InitialLoad") {
            console.log(LOG_PREFIX, `fetchAndApplyConfig called, triggered by: [${triggeredBy}]`);
            if (!supabaseClient || !userIdForThisOverlay) { /* ... */ return; }
            console.log(LOG_PREFIX, "Fetching config for user_id:", userIdForThisOverlay);
            try {
                const { data, error } = await supabaseClient
                    .from('overlay_configurations')
                    .select('config_data')
                    .eq('overlay_type', OVERLAY_TYPE)
                    .eq('user_id', userIdForThisOverlay)
                    .maybeSingle();
                if (error) { /* ... */ displayTicker(null, `FetchConfig-Error-${triggeredBy}`); }
                else if (data && data.config_data) { displayTicker(data.config_data, `FetchConfig-Success-${triggeredBy}`); }
                else { displayTicker(null, `FetchConfig-NoData-${triggeredBy}`); }
            } catch (fetchError) { /* ... */ displayTicker(null, `FetchConfig-Exception-${triggeredBy}`); }
        }

        const updateCommandKey = `${OVERLAY_TYPE}-executeUpdateCmd`;
        window.addEventListener('storage', (event) => {
            if (event.key === updateCommandKey && event.newValue !== null) {
                console.log(LOG_PREFIX, `Received '${updateCommandKey}' from localStorage. Re-fetching config.`);
                fetchAndApplyConfig("LocalStorageUpdate");
            }
        });

        async function main() {
            if (!userIdForThisOverlay) { displayTicker(null, "Main-NoUserID"); return; }
            const supabaseReady = await initializeSupabaseForOverlay();
            if (supabaseReady) { await fetchAndApplyConfig("InitialLoad"); }
            else { displayTicker(null, "Main-SupabaseInitFail"); }
        }

        if (userIdForThisOverlay) { main(); } else { displayTicker(null); }
    </script>
</body>
</html>
