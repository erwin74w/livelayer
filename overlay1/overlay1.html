<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livestream Overlay 1 (Logo)</title>
    <link rel="stylesheet" href="overlay.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <img id="logo" src="" alt="Stream Logo Loading...">
    <script>
        const urlParamsOverlay = new URLSearchParams(window.location.search);
        const userIdForThisOverlay = urlParamsOverlay.get('user');
        const OVERLAY_TYPE = 'logo'; // Define overlay type for this file
        const LOG_PREFIX = `Overlay1 (${OVERLAY_TYPE}) for User [${userIdForThisOverlay || 'NO_USER_ID_PARAM'}]:`;

        console.log(LOG_PREFIX, "Script started. Raw query string:", window.location.search);

        const logoImg = document.getElementById('logo');
        const defaultRepoImagePathPrefix = '../pictures/';
        const defaultLogoFilename = 'overlay1.png';
        const defaultLogoUrl = defaultRepoImagePathPrefix + defaultLogoFilename;
        let supabaseClient = null;
        // REMOVED: let logoRealtimeChannel = null;

        if (!userIdForThisOverlay) { /* ... (same error handling) ... */ }

        async function initializeSupabaseForOverlay() { /* ... (Same as before) ... */ }
        function updateLogoSrc(urlFromConfig, source = "Unknown") { /* ... (Same as before, with robust URL handling and onerror) ... */ }

        async function fetchAndApplyConfig(triggeredBy = "InitialLoad") {
            console.log(LOG_PREFIX, `fetchAndApplyConfig called, triggered by: [${triggeredBy}]`);
            if (!supabaseClient || !userIdForThisOverlay) { /* ... (same guards) ... */ return; }
            console.log(LOG_PREFIX, "Fetching config for user_id:", userIdForThisOverlay);
            try {
                const { data, error } = await supabaseClient
                    .from('overlay_configurations')
                    .select('config_data')
                    .eq('overlay_type', OVERLAY_TYPE)
                    .eq('user_id', userIdForThisOverlay)
                    .maybeSingle();
                if (error) { /* ... (same error handling) ... */ }
                else if (data && data.config_data && typeof data.config_data.url === 'string') {
                    updateLogoSrc(data.config_data.url, `FetchConfig-Success-${triggeredBy}`);
                } else { updateLogoSrc(null, `FetchConfig-NoData-${triggeredBy}`); }
            } catch (fetchError) { /* ... (same error handling) ... */ }
        }

        // Listen for localStorage update commands from the dashboard
        const updateCommandKey = `${OVERLAY_TYPE}-executeUpdateCmd`; // e.g., logo-executeUpdateCmd
        window.addEventListener('storage', (event) => {
            if (event.key === updateCommandKey && event.newValue !== null) { // Check newValue to react only to set/update
                console.log(LOG_PREFIX, `Received '${updateCommandKey}' from localStorage. Old: ${event.oldValue}, New: ${event.newValue}. Re-fetching config.`);
                fetchAndApplyConfig("LocalStorageUpdate");
            }
        });

        async function main() {
            console.log(LOG_PREFIX, "main() called.");
            if (!userIdForThisOverlay) { updateLogoSrc(null, "Main-NoUserID"); return; }
            const supabaseReady = await initializeSupabaseForOverlay();
            if (supabaseReady) {
                await fetchAndApplyConfig("InitialLoad");
                // NO Realtime subscription setup anymore
            } else { updateLogoSrc(null, "Main-SupabaseInitFail"); }
        }

        if (userIdForThisOverlay) { main(); } else { updateLogoSrc(null); }
        // REMOVED: window.addEventListener('beforeunload', for Realtime channel cleanup)
    </script>
</body>
</html>
