        const LOG_PREFIX_DASH = "Dashboard:";
        let supabaseClient = null;
        const initErrorEl = document.getElementById('initError');

        // UI Elements for loading indicators (these are fine as global if only used once)
        const tickerLoadingEl = document.getElementById('tickerLoading');
        const ltLoadingEl = document.getElementById('ltLoading');
        const logoLoadingEl = document.getElementById('logoLoading');

        // --- Generic Feedback Function ---
        function showFeedback(element, message, isSuccess) {
            element.textContent = message;
            element.className = 'feedback ' + (isSuccess ? 'success' : 'error');
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 4000);
        }

        // --- Supabase Initialization ---
        async function initializeSupabase() {
            console.log(LOG_PREFIX_DASH, "Attempting to initialize Supabase...");
            try {
                const response = await fetch('keys.json');
                console.log(LOG_PREFIX_DASH, "Fetched keys.json, status:", response.status);
                if (!response.ok) throw new Error(`HTTP ${response.status} fetching keys.json`);
                const keys = await response.json();
                if (!keys.supabaseUrl || !keys.supabaseAnonKey || keys.supabaseUrl.includes("YOUR_ACTUAL") || keys.supabaseAnonKey.includes("YOUR_ACTUAL")) {
                    throw new Error("Supabase URL/Key missing or placeholder in keys.json.");
                }
                const { createClient } = supabase;
                supabaseClient = createClient(keys.supabaseUrl, keys.supabaseAnonKey);
                console.log(LOG_PREFIX_DASH, "Supabase client initialized successfully.");
                return true;
            } catch (error) {
                console.error(LOG_PREFIX_DASH, "Failed to initialize Supabase:", error.message, error);
                initErrorEl.textContent = `Supabase Initialization Error: ${error.message}. Check console & keys.json. Page functionality will be limited.`;
                initErrorEl.style.display = 'block';
                document.querySelectorAll('details button').forEach(btn => {
                    btn.disabled = true;
                    btn.title = "Supabase not initialized";
                });
                return false;
            }
        }

        // --- Config Data Objects (Corrected Access to formElements) ---
        const overlayControls = [
            {
                id: 'logo',
                loadingEl: logoLoadingEl,
                saveButtonEl: document.getElementById('saveLogoButton'),
                feedbackEl: document.getElementById('logoFeedback'),
                // Define form elements directly here for simpler access in functions
                logoUrlInputEl: document.getElementById('logoUrlInput'),
                visibilityToggleButtonEl: document.getElementById('toggleLogoVisibilityButton'),
                visibilityStorageKey: 'overlay1Visibility',
                textShow: 'Show Logo',
                textHide: 'Hide Logo',
                isVisible: false,
                loadConfigFn: async function() { // Use 'function' to bind 'this' if needed, or pass 'this'
                    const { data, error } = await supabaseClient.from('overlay_configurations').select('config_data').eq('overlay_type', 'logo').maybeSingle();
                    if (error) throw error;
                    if (data && data.config_data) {
                        this.logoUrlInputEl.value = data.config_data.url || '../pictures/overlay1.png';
                    } else { this.logoUrlInputEl.value = '../pictures/overlay1.png';}
                },
                saveConfigFn: async function() {
                    const configData = { url: this.logoUrlInputEl.value.trim() };
                    if (!configData.url) { throw new Error("Logo URL cannot be empty."); }
                    return configData;
                }
            },
            {
                id: 'ticker',
                loadingEl: tickerLoadingEl,
                saveButtonEl: document.getElementById('saveTickerButton'),
                feedbackEl: document.getElementById('tickerFeedback'),
                // Define form elements directly
                tickerMessagesInputEl: document.getElementById('tickerMessagesInput'),
                tickerSeparatorInputEl: document.getElementById('tickerSeparatorInput'),
                manualJsonContainerEl: document.getElementById('manualJsonContainer'),
                manualJsonTextareaEl: document.getElementById('manualJsonTextarea'),
                visibilityToggleButtonEl: document.getElementById('toggleTickerVisibilityButton'),
                visibilityStorageKey: 'overlay2Visibility',
                textShow: 'Show Ticker',
                textHide: 'Hide Ticker',
                isVisible: false,
                loadConfigFn: async function() {
                    const { data, error } = await supabaseClient.from('overlay_configurations').select('config_data').eq('overlay_type', 'ticker').maybeSingle();
                    if (error) throw error;
                    if (data && data.config_data) {
                        this.tickerMessagesInputEl.value = data.config_data.messages.join('\n');
                        this.tickerSeparatorInputEl.value = data.config_data.separator;
                    }
                },
                saveConfigFn: async function() {
                    const messages = this.tickerMessagesInputEl.value.trim().split('\n').map(s => s.trim()).filter(s => s);
                    const separator = this.tickerSeparatorInputEl.value.trim();
                    const configData = { messages, separator };
                    this.manualJsonTextareaEl.value = JSON.stringify(configData, null, 2);
                    return configData;
                }
            },
            {
                id: 'lower_third',
                loadingEl: ltLoadingEl,
                saveButtonEl: document.getElementById('saveLowerThirdButton'),
                feedbackEl: document.getElementById('lowerThirdFeedback'),
                // Define form elements directly
                ltNameInputEl: document.getElementById('ltNameInput'),
                ltFunctionInputEl: document.getElementById('ltFunctionInput'),
                ltAffiliationInputEl: document.getElementById('ltAffiliationInput'),
                visibilityToggleButtonEl: document.getElementById('toggleLtVisibilityButton'),
                visibilityStorageKey: 'overlay3Visibility',
                textShow: 'Show Lower Third',
                textHide: 'Hide Lower Third',
                isVisible: false,
                loadConfigFn: async function() {
                    const { data, error } = await supabaseClient.from('overlay_configurations').select('config_data').eq('overlay_type', 'lower_third').maybeSingle();
                    if (error) throw error;
                    if (data && data.config_data) {
                        this.ltNameInputEl.value = data.config_data.name || '';
                        this.ltFunctionInputEl.value = data.config_data.function || '';
                        this.ltAffiliationInputEl.value = data.config_data.affiliation || '';
                    }
                },
                saveConfigFn: async function() {
                    return {
                        name: this.ltNameInputEl.value.trim(),
                        function: this.ltFunctionInputEl.value.trim(),
                        affiliation: this.ltAffiliationInputEl.value.trim()
                    };
                }
            }
        ];

        // --- Generic Load and Save Config Logic ---
        async function loadAllConfigs() {
            if (!supabaseClient) return;
            console.log(LOG_PREFIX_DASH, "Loading all configurations...");
            for (const control of overlayControls) {
                if (control.loadingEl) control.loadingEl.style.display = 'inline';
                try {
                    console.log(LOG_PREFIX_DASH, `Loading config for: ${control.id}`);
                    // Bind the control object as 'this' for its loadConfigFn
                    await control.loadConfigFn.call(control);
                    console.log(LOG_PREFIX_DASH, `Config loaded for: ${control.id}`);
                } catch (error) {
                    console.error(LOG_PREFIX_DASH, `Error loading config for ${control.id}:`, error.message, error);
                    if (control.feedbackEl) showFeedback(control.feedbackEl, `Error loading ${control.id}: ${error.message}`, false);
                } finally {
                    if (control.loadingEl) control.loadingEl.style.display = 'none';
                }
            }
        }

        overlayControls.forEach(control => {
            if (control.saveButtonEl) {
                control.saveButtonEl.addEventListener('click', async () => {
                    console.log(LOG_PREFIX_DASH, `Save button clicked for: ${control.id}`);
                    if (!supabaseClient) {
                        if (control.feedbackEl) showFeedback(control.feedbackEl, 'Supabase not initialized.', false);
                        return;
                    }
                    control.saveButtonEl.disabled = true;
                    control.saveButtonEl.textContent = 'Saving...';
                    try {
                        // Bind the control object as 'this' for its saveConfigFn
                        const configData = await control.saveConfigFn.call(control);
                        console.log(LOG_PREFIX_DASH, `Attempting to save to Supabase for ${control.id}:`, configData);
                        const { data: upsertData, error } = await supabaseClient.from('overlay_configurations').upsert(
                            { overlay_type: control.id, config_data: configData },
                            { onConflict: 'overlay_type' }
                        );
                        if (error) throw error;
                        console.log(LOG_PREFIX_DASH, `Supabase save successful for ${control.id}. Response:`, upsertData);
                        if (control.feedbackEl) showFeedback(control.feedbackEl, `${control.id.replace('_', ' ')} config saved!`, true);
                        if (control.manualJsonContainerEl) control.manualJsonContainerEl.style.display = 'none';
                    } catch (error) {
                        console.error(LOG_PREFIX_DASH, `Error saving config for ${control.id}:`, error.message, error);
                        if (control.feedbackEl) showFeedback(control.feedbackEl, `Error saving ${control.id}: ${error.message}`, false);
                        if (control.manualJsonContainerEl) control.manualJsonContainerEl.style.display = 'block';
                    } finally {
                        control.saveButtonEl.disabled = false;
                        control.saveButtonEl.textContent = `Save ${control.id.replace('_', ' ')} Config`;
                    }
                });
            }
        });
        // Ticker specific manual copy button
        const copyManualJsonButtonEl = document.getElementById('copyManualJsonButton');
        const copyManualFeedbackEl = document.getElementById('copyManualFeedback');
        if (copyManualJsonButtonEl) {
            copyManualJsonButtonEl.addEventListener('click', async () => {
                const tickerControl = overlayControls.find(c => c.id === 'ticker');
                if (tickerControl && tickerControl.manualJsonTextareaEl) {
                    try { await navigator.clipboard.writeText(tickerControl.manualJsonTextareaEl.value); copyManualFeedbackEl.textContent = 'Copied!'; setTimeout(() => { copyManualFeedbackEl.textContent = ''; }, 2000); }
                    catch (err) { copyManualFeedbackEl.textContent = 'Failed to copy.'; }
                }
            });
        }


        // --- Visibility Toggle Logic ---
        function updateVisibilityButtonUI(control) { /* ... (same as before) ... */ }
        function setOverlayVisibilityInStorage(storageKey, visible) { /* ... (same as before) ... */ }
        function initializeVisibilityToggles() { /* ... (same as before) ... */ }
        window.addEventListener('storage', (event) => { /* ... (same as before) ... */ });


        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log(LOG_PREFIX_DASH, "DOMContentLoaded event.");
            const initialized = await initializeSupabase();
            if (initialized) {
                initErrorEl.style.display = 'none';
                document.querySelectorAll('details button').forEach(btn => btn.disabled = false);
                console.log(LOG_PREFIX_DASH, "Initialization successful. Loading configs and initializing toggles.");
                await loadAllConfigs();
                initializeVisibilityToggles();
                console.log(LOG_PREFIX_DASH, "Dashboard fully initialized.");
            } else {
                console.warn(LOG_PREFIX_DASH, "Supabase not initialized. Dashboard features limited.");
            }
        });
    </script>
