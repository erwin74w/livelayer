<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay Dashboard & Control</title>
    <link rel="stylesheet" href="dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- Authentication Section -->
        <div id="auth-section">
            <div id="login-form-container">
                <h2>Login</h2>
                <form id="login-form">
                    <label for="login-email">Email:</label>
                    <input type="email" id="login-email" required>
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" required>
                    <button type="submit" class="config-save-button">Login</button>
                    <p>Don't have an account? <a href="#" id="show-signup">Sign Up</a></p>
                </form>
            </div>

            <div id="signup-form-container" style="display:none;">
                <h2>Sign Up</h2>
                <form id="signup-form">
                    <label for="signup-email">Email:</label>
                    <input type="email" id="signup-email" required>
                    <label for="signup-password">Password:</label>
                    <input type="password" id="signup-password" required minlength="6">
                    <button type="submit" class="config-save-button">Sign Up</button>
                    <p>Already have an account? <a href="#" id="show-login">Login</a></p>
                </form>
            </div>
            <div id="auth-feedback" class="feedback" style="display:none;"></div>
        </div>

        <!-- Dashboard Content (shown after login) -->
        <div id="dashboard-content" style="display:none;">
            <h1>Overlay Dashboard</h1>
            <div style="margin-bottom: 15px;">
                Logged in as: <strong id="user-email-display"></strong>
                <button id="logout-button" class="config-save-button secondary" style="float: right; margin-top: -5px;">Logout</button>
            </div>
            <div id="initError" style="display:none;">Supabase Initialization Error. Check console & keys.json.</div>
            <p>Manage overlay configurations and toggle their visibility for your stream.</p>
            <div>
                Your public overlay URL (for Prism/OBS Browser Source):
                <br>
                <code id="public-overlay-url" style="display:inline-block; margin-top:5px; padding:5px; background-color:#eee; border-radius:3px; word-break:break-all;"></code>
                <button id="copy-public-url-button" class="config-save-button secondary" style="margin-left:10px; padding: 5px 10px; font-size:0.8em;">Copy URL</button>
                <span id="copy-url-feedback" style="font-size:0.8em; margin-left:5px;"></span>
            </div>
            <hr style="margin: 20px 0;">


            <!-- Logo (Overlay 1) -->
            <details id="details-logo">
                <summary>
                    <div class="summary-controls">
                        <div class="summary-title-area">Logo (Overlay 1) <span id="loading-logo" class="loading-indicator" style="display:none;">Loading...</span></div>
                        <button id="toggle-logo" class="toggle-visibility-button" disabled>Show Logo</button>
                    </div>
                </summary>
                <div class="details-content">
                    <label for="input-logo-url">Logo Image URL:</label>
                    <input type="text" id="input-logo-url" placeholder="../pictures/overlay1.png">
                    <button id="save-logo" class="config-save-button" disabled>Save Logo Config</button>
                    <div id="feedback-logo" class="feedback" style="display:none;"></div>
                </div>
            </details>

            <!-- Ticker (Overlay 2) -->
            <details id="details-ticker">
                <summary>
                    <div class="summary-controls">
                         <div class="summary-title-area">Ticker (Overlay 2) <span id="loading-ticker" class="loading-indicator" style="display:none;">Loading...</span></div>
                        <button id="toggle-ticker" class="toggle-visibility-button" disabled>Show Ticker</button>
                    </div>
                </summary>
                <div class="details-content">
                    <label for="input-ticker-messages">Ticker Messages (one per line):</label>
                    <textarea id="input-ticker-messages" placeholder="Message 1\nMessage 2"></textarea>
                    <label for="input-ticker-separator">Message Separator:</label>
                    <input type="text" id="input-ticker-separator" value=" +++ ">
                    <button id="save-ticker" class="config-save-button" disabled>Save Ticker Config</button>
                    <div id="feedback-ticker" class="feedback" style="display:none;"></div>
                    <div id="manualJsonContainer-ticker" class="manual-json-container" style="display:none;">
                         <p><strong>Fallback:</strong> If Supabase save fails, copy this JSON:</p>
                        <textarea id="manualJsonTextarea-ticker" class="manual-json-textarea" readonly></textarea>
                        <button id="copyManualJsonButton-ticker" class="config-save-button secondary">Copy Fallback JSON</button>
                        <span id="copyManualFeedback-ticker" class="copy-manual-feedback"></span>
                    </div>
                </div>
            </details>

            <!-- Lower Third (Overlay 3) -->
            <details id="details-lower_third">
                <summary>
                    <div class="summary-controls">
                        <div class="summary-title-area">Lower Third (Overlay 3) <span id="loading-lower_third" class="loading-indicator" style="display:none;">Loading...</span></div>
                        <button id="toggle-lower_third" class="toggle-visibility-button" disabled>Show Lower Third</button>
                    </div>
                </summary>
                <div class="details-content">
                    <label for="input-lower_third-name">Name:</label>
                    <input type="text" id="input-lower_third-name" placeholder="Jane Doe">
                    <label for="input-lower_third-function">Function/Title:</label>
                    <input type="text" id="input-lower_third-function" placeholder="Lead Developer">
                    <label for="input-lower_third-affiliation">Affiliation/Company:</label>
                    <input type="text" id="input-lower_third-affiliation" placeholder="Awesome Inc.">
                    <button id="save-lower_third" class="config-save-button" disabled>Save Lower Third Config</button>
                    <div id="feedback-lower_third" class="feedback" style="display:none;"></div>
                </div>
            </details>
        </div><!-- /dashboard-content -->
    </div><!-- /container -->

    <script>
        // JavaScript from the previous "Full Code (Corrected)" response,
        // with the addition of Auth UI handling and session management.
        // All the overlayControls array, load/save functions, visibility toggle functions
        // remain structurally the same but will operate within the context of an authenticated user.

        const LOG_PREFIX_DASH = "Dashboard:";
        let supabaseClient = null;
        let currentUser = null; // Store current user session

        const initErrorEl = getEl('initError');
        // Auth UI elements
        const authSectionEl = getEl('auth-section');
        const dashboardContentEl = getEl('dashboard-content');
        const loginFormEl = getEl('login-form');
        const signupFormEl = getEl('signup-form');
        const loginFormContainerEl = getEl('login-form-container');
        const signupFormContainerEl = getEl('signup-form-container');
        const showSignupLinkEl = getEl('show-signup');
        const showLoginLinkEl = getEl('show-login');
        const authFeedbackEl = getEl('auth-feedback');
        const userEmailDisplayEl = getEl('user-email-display');
        const logoutButtonEl = getEl('logout-button');
        const publicOverlayUrlEl = getEl('public-overlay-url');
        const copyPublicUrlButtonEl = getEl('copy-public-url-button');
        const copyUrlFeedbackEl = getEl('copy-url-feedback');


        // --- Utility Functions ---
        function getEl(id) { return document.getElementById(id); }
        function showFeedback(element, message, isSuccess, duration = 4000) {
            if (!element) { console.warn(LOG_PREFIX_DASH, "Feedback element not found for message:", message); return; }
            element.textContent = message;
            element.className = 'feedback ' + (isSuccess ? 'success' : 'error');
            element.style.display = 'block';
            if (duration > 0) {
                setTimeout(() => { element.style.display = 'none'; }, duration);
            }
        }

        // --- Supabase Initialization ---
        async function initializeSupabase() {
            console.log(LOG_PREFIX_DASH, "Attempting to initialize Supabase...");
            try {
                const response = await fetch('keys.json');
                console.log(LOG_PREFIX_DASH, "Fetched keys.json, status:", response.status);
                if (!response.ok) throw new Error(`HTTP ${response.status} fetching keys.json`);
                const keys = await response.json();
                if (!keys.supabaseUrl || !keys.supabaseAnonKey || keys.supabaseUrl.includes("YOUR_ACTUAL") || keys.supabaseAnonKey.includes("YOUR_ACTUAL")) {
                    throw new Error("Supabase URL/Key missing or placeholder in keys.json.");
                }
                const { createClient } = supabase;
                supabaseClient = createClient(keys.supabaseUrl, keys.supabaseAnonKey, {
                    auth: {
                        // autoRefreshToken: true, // default
                        // persistSession: true, // default
                        // detectSessionInUrl: true // default, for OAuth redirects
                    }
                });
                console.log(LOG_PREFIX_DASH, "Supabase client initialized successfully.");
                return true;
            } catch (error) {
                console.error(LOG_PREFIX_DASH, "Failed to initialize Supabase:", error.message, error);
                initErrorEl.textContent = `Supabase Initialization Error: ${error.message}. Check console & keys.json. Page functionality will be limited.`;
                initErrorEl.style.display = 'block';
                authSectionEl.innerHTML = `<p class="error">${initErrorEl.textContent}</p>`; // Show error in auth section too
                return false;
            }
        }

        // --- Authentication Logic ---
        loginFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = getEl('login-email').value;
            const password = getEl('login-password').value;
            showFeedback(authFeedbackEl, "Logging in...", true, 0); // Indefinite until result
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) {
                showFeedback(authFeedbackEl, `Login failed: ${error.message}`, false);
            } else {
                showFeedback(authFeedbackEl, "Login successful!", true);
                // onAuthStateChange will handle UI update
            }
        });

        signupFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = getEl('signup-email').value;
            const password = getEl('signup-password').value;
            showFeedback(authFeedbackEl, "Signing up...", true, 0);
            const { data, error } = await supabaseClient.auth.signUp({ email, password });
            if (error) {
                showFeedback(authFeedbackEl, `Sign up failed: ${error.message}`, false);
            } else {
                showFeedback(authFeedbackEl, "Sign up successful! Please check your email to confirm.", true, 10000);
                // User needs to confirm email. onAuthStateChange will eventually pick up the session.
            }
        });

        logoutButtonEl.addEventListener('click', async () => {
            const { error } = await supabaseClient.auth.signOut();
            if (error) console.error(LOG_PREFIX_DASH, "Logout error:", error);
            // onAuthStateChange handles UI update
        });

        showSignupLinkEl.addEventListener('click', (e) => {
            e.preventDefault();
            loginFormContainerEl.style.display = 'none';
            signupFormContainerEl.style.display = 'block';
            authFeedbackEl.style.display = 'none';
        });
        showLoginLinkEl.addEventListener('click', (e) => {
            e.preventDefault();
            signupFormContainerEl.style.display = 'none';
            loginFormContainerEl.style.display = 'block';
            authFeedbackEl.style.display = 'none';
        });

        copyPublicUrlButtonEl.addEventListener('click', async () => {
            const urlToCopy = publicOverlayUrlEl.textContent;
            if (!urlToCopy || urlToCopy === 'Login to see your overlay URL.') {
                copyUrlFeedbackEl.textContent = "No URL to copy.";
                setTimeout(() => { copyUrlFeedbackEl.textContent = ''; }, 2000);
                return;
            }
            try {
                await navigator.clipboard.writeText(urlToCopy);
                copyUrlFeedbackEl.textContent = "Copied!";
            } catch (err) {
                copyUrlFeedbackEl.textContent = "Copy failed.";
                console.error("Failed to copy public URL:", err);
            }
            setTimeout(() => { copyUrlFeedbackEl.textContent = ''; }, 3000);
        });


        function updateUIBasedOnAuthState(user) {
            currentUser = user;
            if (user) {
                console.log(LOG_PREFIX_DASH, "User is logged in:", user.email);
                authSectionEl.style.display = 'none';
                dashboardContentEl.style.display = 'block';
                userEmailDisplayEl.textContent = user.email;

                // Construct and display public overlay URL
                // For MVP, using user.id. Consider a non-guessable public_share_id for production.
                const baseOverlayPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
                const publicUrl = `${window.location.origin}${baseOverlayPath}index.html?user=${user.id}`;
                publicOverlayUrlEl.textContent = publicUrl;

                document.querySelectorAll('details button.config-save-button, details button.toggle-visibility-button').forEach(btn => btn.disabled = false);
                loadAllConfigs(); // Load configs for this user
                initializeVisibilityToggles(); // Initialize toggles based on this user's localStorage context
            } else {
                console.log(LOG_PREFIX_DASH, "User is logged out.");
                authSectionEl.style.display = 'block';
                dashboardContentEl.style.display = 'none';
                loginFormContainerEl.style.display = 'block'; // Default to login form
                signupFormContainerEl.style.display = 'none';
                publicOverlayUrlEl.textContent = 'Login to see your overlay URL.';
                document.querySelectorAll('details button.config-save-button, details button.toggle-visibility-button').forEach(btn => btn.disabled = true);
            }
        }

        // --- Overlay Control Configuration Array & Logic ---
        // The overlayControls array and its associated load/save functions
        // are identical to the "Corrected Full Code" of dashboard.html from the previous response.
        // They will now operate under the authenticated user's context due to RLS.
        // For brevity, I will not repeat the entire 'overlayControls' array and its methods here.
        // Please ensure you copy it from the previous correct version.
        const overlayControls = [ /* ... (Full array from previous response) ... */
             {
                type: 'logo', displayName: 'Logo',
                elements: { loading: getEl('loading-logo'), saveButton: getEl('save-logo'), feedback: getEl('feedback-logo'), url: getEl('input-logo-url'), toggleButton: getEl('toggle-logo')},
                visibility: { storageKey: 'overlay1Visibility', textShow: 'Show Logo', textHide: 'Hide Logo', isVisible: false },
                load: async function() { /* ... uses this.elements ... */ }, save: async function() { /* ... uses this.elements ... */ }
            },
            {
                type: 'ticker', displayName: 'Ticker',
                elements: { loading: getEl('loading-ticker'), saveButton: getEl('save-ticker'), feedback: getEl('feedback-ticker'), messages: getEl('input-ticker-messages'), separator: getEl('input-ticker-separator'), manualJsonContainer: getEl('manualJsonContainer-ticker'), manualJsonTextarea: getEl('manualJsonTextarea-ticker'), copyManualJsonButton: getEl('copyManualJsonButton-ticker'), copyManualFeedback: getEl('copyManualFeedback-ticker'), toggleButton: getEl('toggle-ticker')},
                visibility: { storageKey: 'overlay2Visibility', textShow: 'Show Ticker', textHide: 'Hide Ticker', isVisible: false },
                load: async function() { /* ... uses this.elements ... */ }, save: async function() { /* ... uses this.elements ... */ }
            },
            {
                type: 'lower_third', displayName: 'Lower Third',
                elements: { loading: getEl('loading-lower_third'), saveButton: getEl('save-lower_third'), feedback: getEl('feedback-lower_third'), name: getEl('input-lower_third-name'), function: getEl('input-lower_third-function'), affiliation: getEl('input-lower_third-affiliation'), toggleButton: getEl('toggle-lower_third')},
                visibility: { storageKey: 'overlay3Visibility', textShow: 'Show Lower Third', textHide: 'Hide Lower Third', isVisible: false },
                load: async function() { /* ... uses this.elements ... */ }, save: async function() { /* ... uses this.elements ... */ }
            }
        ];
        async function loadAllConfigs() { /* ... (same as previous) ... */ }
        // Attach save event listeners loop (same as previous)
        overlayControls.forEach(control => { if (control.elements.saveButton) { control.elements.saveButton.addEventListener('click', async () => { /* ... */ }); } /* ... ticker copy button ... */ });
        function updateVisibilityButtonUI(control) { /* ... (same) ... */ }
        function setOverlayVisibilityInStorage(storageKey, visible) { /* ... (same) ... */ }
        function initializeVisibilityToggles() { /* ... (same) ... */ }
        window.addEventListener('storage', (event) => { /* ... (same) ... */ });


        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log(LOG_PREFIX_DASH, "DOMContentLoaded event.");
            const initialized = await initializeSupabase();
            if (initialized) {
                initErrorEl.style.display = 'none'; // Hide general init error if supabase is ok

                // Listen for auth state changes (login, logout, token refresh)
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log(LOG_PREFIX_DASH, "Auth state changed. Event:", event, "Session:", session);
                    updateUIBasedOnAuthState(session?.user || null);
                });

                // Check initial session
                const { data: { session } } = await supabaseClient.auth.getSession();
                console.log(LOG_PREFIX_DASH, "Initial session:", session);
                updateUIBasedOnAuthState(session?.user || null);

            } else {
                console.warn(LOG_PREFIX_DASH, "Supabase not initialized. Dashboard cannot function.");
                // Error already shown by initializeSupabase()
            }
        });
    </script>
</body>
</html>
